<form method="post" action="{{ routes.cart_url }}" id="mini-cart" class="mini-cart{% if settings.cart_type == 'drawer' %} mini-cart--drawer{% endif %}" aria-hidden="true" novalidate="novalidate" data-item-count="{{ cart.item_count }}">
  <input type="hidden" name="attributes[collection_products_per_page]" value="">
  <input type="hidden" name="attributes[collection_layout]" value="">

  {%- render 'icon', icon: 'nav-triangle-borderless' -%}

  {%- capture shipping_alert -%}
    {%- if settings.cart_show_free_shipping_threshold -%}
      {%- assign threshold_in_cents = settings.cart_free_shipping_threshold | times: 100 -%}

      {%- if cart.total_price >= threshold_in_cents -%}
        <p class="alert alert--tight alert--center text--strong">{{ 'cart.general.free_shipping' | t }}</p>
      {%- else -%}
        {%- capture remaining_amount -%}<span>{{ cart.total_price | minus: threshold_in_cents | abs | money }}</span>{%- endcapture -%}
        <p class="alert alert--tight alert--center text--strong">{{ 'cart.general.free_shipping_remaining_html' | t: remaining_amount: remaining_amount }}</p>
      {%- endif -%}
    {%- endif -%}
  {%- endcapture -%}

  {%- if cart.item_count == 0 -%}
    <div class="mini-cart__content mini-cart__content--empty">
      {%- if shipping_alert != blank -%}
        {{- shipping_alert -}}
      {%- endif -%}

      <div class="mini-cart__empty-state">
        {%- render 'icon', icon: 'big-cart' -%}
        <p class="heading h4">{{ 'cart.general.empty' | t }}</p>
      </div>

      <a href="{{ settings.cart_empty_button_link }}" class="button button--primary button--full">{{ 'cart.general.empty_button' | t }}</a>
    </div>
  {%- else -%}
    <div class="mini-cart__inner">
      <!-- Resize handle -->
      <div class="mini-cart__resize-handle" id="miniCartResizeHandle" title="Drag to resize" onmousedown="event.stopPropagation();">
        <div class="mini-cart__resize-grip">
          <span></span><span></span><span></span>
        </div>
      </div>
      <button class="close-button mini-cart__close-button" aria-label="Close cart" type="button" onclick="closeMiniCart()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
          <path d="M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <path d="M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>
      <div class="mini-cart__free-shipping-banner" style="padding: 12px 10px; background: #f7f7f7; color: #234240; font-weight: bold; text-align: center;">
        Spend $349 and get free shipping! (US only)
      </div>
      <div class="mini-cart__content">
        {%- if shipping_alert != blank -%}
          <div class="mini-cart__alert-wrapper">
            {{- shipping_alert -}}
          </div>
        {%- endif -%}

        <div class="mini-cart__line-item-list">
          {%- for line_item in cart.items -%}
            <div class="mini-cart__line-item">
              {%- if line_item.image != blank -%}
                <div class="mini-cart__image-wrapper">
                  {%- comment -%}For vertical images we force to contain them on a square ratio to avoid growing too large{%- endcomment -%}

                  {%- if line_item.image.aspect_ratio < 1 -%}
                    <div class="aspect-ratio aspect-ratio--square">
                      {{- line_item.image | image_url: width: line_item.image.width | image_tag: loading: 'lazy', sizes: '180px', widths: '180,360' -}}
                    </div>
                  {%- else -%}
                    <div class="aspect-ratio" style="padding-bottom: {{ 100.0 | divided_by: line_item.image.aspect_ratio }}%">
                      {{- line_item.image | image_url: width: line_item.image.width | image_tag: loading: 'lazy', sizes: '180px', widths: '180,360' -}}
                    </div>
                  {%- endif -%}
                </div>
              {%- endif -%}

              <div class="mini-cart__item-wrapper">
                <div class="mini-cart__product-info">
                  {%- unless line_item.product.tags contains '__gift' -%}
                    {%- if settings.show_vendor -%}
                      {%- assign vendor_handle = line_item.product.vendor | handle -%}
                      {%- assign collection_for_vendor = collections[vendor_handle] -%}

                      {%- unless collection_for_vendor.empty? -%}
                        <a class="mini-cart__product-vendor link" href="{{ collection_for_vendor.url }}">{{ line_item.product.vendor }}</a>
                        {%- else -%}
                        <a class="mini-cart__product-vendor link" href="{{ line_item.product.vendor | url_for_vendor }}">{{ line_item.product.vendor }}</a>
                      {%- endunless -%}
                    {%- endif -%}
                  {%- endunless -%}

                  <a href="{{ line_item.url }}" class="mini-cart__product-title text--strong link">{{ line_item.title }}</a>

                  {%- if line_item.selling_plan_allocation -%}
                    <p class="mini-cart__plan-allocation">{{ line_item.selling_plan_allocation.selling_plan.name }}</p>
                  {%- endif -%}

                  {%- unless line_item.properties == blank -%}
                    <ul class="mini-cart__property-list" role="list">
                      {%- for property in line_item.properties -%}
                        {%- assign first_character_in_key = property.first | truncate: 1, '' -%}

                        {%- if property.last == blank or first_character_in_key == '_' -%}
                          {%- continue -%}
                        {%- endif -%}

                        <li class="mini-cart__property">{{ property.first }}: {{ property.last }}</li>
                      {%- endfor -%}
                    </ul>
                  {%- endunless -%}

                  {%- comment -%}If we have a Shopify Script, we use the reduced price here, otherwise we check the compare at price{%- endcomment -%}

                  <div class="mini-cart__price-list">
                    {%- if line_item.final_line_price < line_item.original_line_price -%}
                      {%- if line_item.final_price == 0 -%}
                        <span class="price price--highlight">{{ 'cart.general.free' | t }}</span>
                      {%- else -%}
                        <span class="price price--highlight">{{ line_item.final_line_price | money }}</span>
                      {%- endif -%}

                      <span class="price price--compare">{{ line_item.original_line_price | money }}</span>
                    {%- elsif line_item.variant.compare_at_price > line_item.variant.price -%}
                      <span class="price price--highlight">{{ line_item.final_line_price | money }}</span>
                      <span class="price price--compare">{{ line_item.variant.compare_at_price | times: line_item.quantity | money }}</span>
                    {%- else -%}
                      <span class="price">{{ line_item.final_line_price | money }}</span>
                    {%- endif -%}
                  </div>

                  {%- if line_item.unit_price_measurement -%}
                    <div class="mini-cart__price-info">
                      <div class="unit-price-measurement">
                        <span class="unit-price-measurement__price">{{ line_item.unit_price | money }}</span>
                        <span class="unit-price-measurement__separator">/ </span>

                        {%- if line_item.unit_price_measurement.reference_value != 1 -%}
                          <span class="unit-price-measurement__reference-value">{{ line_item.unit_price_measurement.reference_value }}</span>
                        {%- endif -%}

                        <span class="unit-price-measurement__reference-unit">{{ line_item.unit_price_measurement.reference_unit }}</span>
                      </div>
                    </div>
                  {%- endif -%}

                  {%- if line_item.line_level_discount_allocations != blank -%}
                    <ul class="mini-cart__discount-list" role="list">
                      {%- for discount_allocation in line_item.line_level_discount_allocations -%}
                        <li class="mini-cart__discount">
                          {%- render 'icon', icon: 'sale' -%}{{ discount_allocation.discount_application.title }} (-{{ discount_allocation.amount | money }})
                        </li>
                      {%- endfor -%}
                    </ul>
                  {%- endif -%}
                </div>

                {%- comment -%}If the product has the tag "__gift", we remove the price{%- endcomment -%}

                {%- unless line_item.product.tags contains '__gift' -%}
                  <div class="mini-cart__quantity">
                    <div class="quantity-selector">
                      {% liquid
                        assign max_quantity = ''
                        assign variant = line_item.variant
                  
                        if variant.inventory_management != blank and variant.inventory_policy == 'deny'
                          assign current_quantity_for_variant = cart | item_count_for_variant: variant.id
                          assign max_quantity = variant.inventory_quantity | minus: current_quantity_for_variant | plus: line_item.quantity
                        endif
                  
                        if variant.quantity_rule.max != nil
                          assign max_quantity = max_quantity | default: 999999 | at_most: variant.quantity_rule.max
                        endif

                        assign increment = line_item.quantity | plus: line_item.variant.quantity_rule.increment

                        if line_item.variant.quantity_rule.max != nil
                          assign increment = increment | at_most: line_item.variant.quantity_rule.max
                        endif
                      %}

                      <button class="quantity-selector__button" data-action="decrease-quantity" data-quantity="{{ line_item.quantity | minus: line_item.variant.quantity_rule.increment | at_least: 0 }}" data-line="{{ forloop.index }}" aria-label="{{ 'cart.items.decrease_quantity' | t }}" title="{{ 'cart.items.decrease_quantity' | t }}">{% render 'icon', icon: 'minus' %}</button>
                      <input aria-label="{{ 'product.form.quantity' | t }}" class="quantity-selector__value" type="number" inputmode="numeric" data-current-value="{{ line_item.quantity }}" data-line="{{ forloop.index }}" value="{{ line_item.quantity }}" step="{{ line_item.variant.quantity_rule.increment }}" min="{{ line_item.variant.quantity_rule.min }}" {% if line_item.variant.quantity_rule.max != nil %}max="{{ line_item.variant.quantity_rule.max }}"{% endif %}>
                      <button class="quantity-selector__button" data-action="increase-quantity" data-quantity="{{ increment }}" data-line="{{ forloop.index }}" {% if max_quantity == blank or line_item.quantity < max_quantity %}aria-label="{{ 'cart.items.increase_quantity' | t }}" title="{{ 'cart.items.increase_quantity' | t }}"{% else %}disabled="disabled" aria-label="{{ 'cart.items.no_more_stock' | t }}" data-tooltip="{{ 'cart.items.no_more_stock' | t }}" data-tooltip-position="bottom-left"{% endif %}>{% render 'icon', icon: 'plus' %}</button>
                    </div>

                    <a href="{{ routes.cart_change_url }}?quantity=0&line={{ forloop.index }}" data-action="decrease-quantity" data-quantity="0" data-line="{{ forloop.index }}" class="mini-cart__quantity-remove link">{{ 'cart.items.remove' | t }}</a>
                  </div>
                {%- endunless -%}
              </div>
            </div>
          {%- endfor -%}
        </div>
      </div>

      <div class="mini-cart__recap">
        <div class="mini-cart__info-block" style="margin-bottom: 18px;">
          <div style="margin-bottom: 8px; color: #234240;">Shipping calculated at checkout</div>
          <div id="termsCheckboxContainer" style="background: #f0f7f4; border: 2px solid #70a491; border-radius: 8px; padding: 12px; margin-bottom: 8px;">
            <label style="display: flex; align-items: center; font-size: 14px; cursor: pointer; gap: 12px; margin: 0;">
              <input id="miniCartTermsCheckbox" type="checkbox" required style="width: 22px; height: 22px; min-width: 22px; accent-color: #234240; cursor: pointer; margin: 0; flex-shrink: 0;">
              <span style="color: #234240; line-height: 1.4;">
                I have read and agree to Detox RejuveNation's
                <a href="/pages/terms-and-conditions" target="_blank" style="color: #70a491; text-decoration: underline;">terms and conditions</a>.
              </span>
            </label>
          </div>
        </div>

        {%- comment -%}Cart Note Section{%- endcomment -%}
        <div class="mini-cart__note-block" style="margin-bottom: 5px;">
          <div id="miniCartNoteToggle" style="display: flex; align-items: center; justify-content: space-between; font-size: 14px; cursor: pointer; color: #234240; padding: 5px 0; user-select: none;">
            <span id="miniCartNoteLabel">Add a note for our team:</span>
            <svg id="miniCartNoteChevron" width="16" height="16" viewBox="0 0 16 16" style="transition: transform 0.3s ease; flex-shrink: 0;">
              <path d="M4 6l4 4 4-4" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
          <div id="miniCartNoteBox" style="margin-top: 5px; display: none; overflow: hidden; transition: all 0.3s ease;">
            <textarea 
              id="miniCartNoteText" 
              name="note" 
              placeholder="Add special instructions or notes for your order..."
              style="width: 100%; min-height: 80px; padding: 10px; border: 1px solid #d1d1d1; border-radius: 4px; font-size: 14px; font-family: inherit; resize: vertical; box-sizing: border-box;"
            >{{ cart.note }}</textarea>
            <button 
              id="miniCartNoteSave" 
              type="button"
              style="margin-top: 8px; padding: 8px 16px; background-color: #234240; color: white; border: none; border-radius: 50px; cursor: pointer; font-size: 14px; font-weight: 500; transition: opacity 0.2s;"
              onmouseover="this.style.opacity='0.85'"
              onmouseout="this.style.opacity='1'"
            >Save</button>
          </div>
        </div>

        {%- if cart.cart_level_discount_applications != blank -%}
          {%- for discount_application in cart.cart_level_discount_applications -%}
            <div class="mini-cart__recap-price-line mini-cart__recap-price-line--highlight text--pull">
              <span>{{ discount_application.title }}</span>
              <span>-{{ discount_application.total_allocated_amount | money }}</span>
            </div>
          {%- endfor -%}
        {%- endif -%}

        <div class="mini-cart__recap-price-line">
          <span>{{ 'cart.general.total' | t }}</span>
          <span>{{ cart.total_price | money_with_currency }}</span>
        </div>

        {%- comment -%}To calculate the total discount, we take both into account the Shopify Script (for Plus merchants), but we also add the compare at price{%- endcomment -%}

        {%- assign total_discount = 0 -%}

        {%- for line_item in cart.items -%}
          {%- if line_item.final_line_price < line_item.original_line_price -%}
            {%- assign total_discount = total_discount | plus: line_item.total_discount -%}
          {%- elsif line_item.variant.compare_at_price > line_item.variant.price -%}
            {%- assign line_discount = line_item.variant.compare_at_price | minus: line_item.variant.price | times: line_item.quantity -%}
            {%- assign total_discount = total_discount | plus: line_discount -%}
          {%- endif -%}
        {%- endfor -%}

        {%- if total_discount > 0 -%}
          {%- capture amount_saved -%}<span>{{ total_discount | money }}</span>{%- endcapture -%}
          <span class="mini-cart__amount-saved">{{ 'cart.general.amount_saved_html' | t: amount_saved: amount_saved }}</span>
        {%- endif -%}

        <div class="mini-cart__button-container">
          <div class="button-group button-group--loose button-group--fit">
            <!-- Removed the View Cart button -->
            {% comment %} <a href="{{ routes.cart_url }}" class="button button--secondary" data-no-instant>{{ 'cart.general.view_cart' | t }}</a> {% endcomment %}
            {%- if settings.cart_show_checkout_button -%}
              <button id="miniCartCheckoutButton" type="submit" name="checkout" class="button button--primary button--full" disabled style="transition: all 0.3s ease; opacity: 0.5; cursor: not-allowed; background-color: #234240 !important; border-color: #234240;">Checkout</button>
            {%- endif -%}
          </div>
        </div>

        {%- if settings.hide_express_checkout_buttons -%}
          {%- comment -%}
            By showing the div in the cart but hiding it in CSS, the express checkout buttons are hidden from the first step of the checkout, and
            are rather deferred to the payment step. This is a hacky trick, but it is often requested by merchants.
          {%- endcomment -%}

          {%- if additional_checkout_buttons -%}
            <div class="additional-checkout-buttons" style="display: none !important">
              {{ content_for_additional_checkout_buttons }}
            </div>
          {%- endif -%}
        {%- endif -%}
      </div>
    </div>
  {%- endif -%}
</form>
<script>
  function closeMiniCart() {
    const miniCart = document.getElementById('mini-cart');
    const cartToggle = document.querySelector('.header__cart-toggle');
    
    if (miniCart) {
      miniCart.setAttribute('aria-hidden', 'true');
      document.body.classList.remove('no-mobile-scroll');
    }
    
    if (cartToggle) {
      cartToggle.setAttribute('aria-expanded', 'false');
    }
  }

  // Mini-cart resize functionality
  (function() {
    let isResizing = false;
    let startX = 0;
    let startWidth = 0;
    const minWidth = 375;
    let resizeHandle = null;
    let miniCart = null;
    
    function getMaxWidth() {
      return Math.min(window.innerWidth * 0.9, 800);
    }
    
    function setupMiniCartResize() {
      miniCart = document.getElementById('mini-cart');
      resizeHandle = document.getElementById('miniCartResizeHandle');
      
      if (!miniCart || !resizeHandle) return;
      
      // Restore saved width from localStorage
      const savedWidth = localStorage.getItem('miniCartWidth');
      if (savedWidth) {
        const width = parseInt(savedWidth, 10);
        if (width >= minWidth && width <= getMaxWidth()) {
          miniCart.style.width = width + 'px';
        }
      }
    }
    
    function startResize(e) {
      miniCart = document.getElementById('mini-cart');
      resizeHandle = document.getElementById('miniCartResizeHandle');
      
      if (!miniCart || !resizeHandle) return;
      
      isResizing = true;
      startX = e.clientX || (e.touches && e.touches[0].clientX) || 0;
      startWidth = miniCart.offsetWidth;
      
      miniCart.classList.add('is-resizing');
      resizeHandle.classList.add('is-resizing');
      document.body.style.cursor = 'ew-resize';
      document.body.style.userSelect = 'none';
      document.body.style.webkitUserSelect = 'none';
      
      e.preventDefault();
      e.stopPropagation();
    }
    
    function doResize(e) {
      if (!isResizing || !miniCart) return;
      
      const clientX = e.clientX || (e.touches && e.touches[0].clientX);
      if (clientX === undefined) return;
      
      // Calculate new width (dragging left increases width since drawer is on right)
      const diff = startX - clientX;
      let newWidth = startWidth + diff;
      
      // Clamp to min/max
      newWidth = Math.max(minWidth, Math.min(getMaxWidth(), newWidth));
      
      miniCart.style.width = newWidth + 'px';
      
      e.preventDefault();
    }
    
    function stopResize(e) {
      if (!isResizing) return;
      
      isResizing = false;
      
      if (miniCart) {
        miniCart.classList.remove('is-resizing');
        // Save width to localStorage
        localStorage.setItem('miniCartWidth', miniCart.offsetWidth);
      }
      
      if (resizeHandle) {
        resizeHandle.classList.remove('is-resizing');
      }
      
      document.body.style.cursor = '';
      document.body.style.userSelect = '';
      document.body.style.webkitUserSelect = '';
    }
    
    // Use capture phase to get events before theme JS
    document.addEventListener('mousedown', function(e) {
      if (e.target.closest('#miniCartResizeHandle')) {
        startResize(e);
      }
    }, true);
    
    document.addEventListener('mousemove', doResize, true);
    document.addEventListener('mouseup', stopResize, true);
    
    // Touch events
    document.addEventListener('touchstart', function(e) {
      if (e.target.closest('#miniCartResizeHandle')) {
        startResize(e);
      }
    }, { capture: true, passive: false });
    
    document.addEventListener('touchmove', function(e) {
      if (isResizing) {
        doResize(e);
      }
    }, { capture: true, passive: false });
    
    document.addEventListener('touchend', stopResize, true);
    
    // Update max width on window resize
    window.addEventListener('resize', function() {
      const cart = document.getElementById('mini-cart');
      if (cart) {
        const currentWidth = cart.offsetWidth;
        const newMaxWidth = getMaxWidth();
        if (currentWidth > newMaxWidth) {
          cart.style.width = newMaxWidth + 'px';
        }
      }
    });
    
    // Initialize on page load
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', setupMiniCartResize);
    } else {
      setupMiniCartResize();
    }
    
    // Re-initialize when mini-cart content is replaced (after cart updates)
    const originalInnerHTML = Object.getOwnPropertyDescriptor(Element.prototype, 'innerHTML');
    // Also setup on theme events
    document.addEventListener('theme:loading:end', setupMiniCartResize);
  })();

  function updateMiniCartButtonStyle(button, isEnabled) {
    const container = document.getElementById('termsCheckboxContainer');
    if (isEnabled) {
      button.style.opacity = '1';
      button.style.cursor = 'pointer';
      button.style.backgroundColor = '#234240';
      button.style.borderColor = '#234240';
      if (container) {
        container.style.borderColor = '#70a491';
        container.style.background = '#f0f7f4';
      }
    } else {
      button.style.opacity = '0.5';
      button.style.cursor = 'not-allowed';
      button.style.backgroundColor = '#234240';
      button.style.borderColor = '#234240';
      if (container) {
        container.style.borderColor = '#e8a87c';
        container.style.background = '#fff8f5';
      }
    }
  }

  let checkboxHandler = null; // Current handler reference
  let boundCheckbox = null;   // The checkbox element we are currently bound to

  function setupMiniCartCheckout() {
    const checkbox = document.getElementById('miniCartTermsCheckbox');
    const checkoutBtn = document.getElementById('miniCartCheckoutButton');
    
    if (!checkbox || !checkoutBtn) return;

    // Detach from previous checkbox if different
    if (boundCheckbox && checkboxHandler && boundCheckbox !== checkbox) {
      try { boundCheckbox.removeEventListener('change', checkboxHandler); } catch(e) {}
    }

    // Restore persisted state
    const persistedAccepted = sessionStorage.getItem('miniCartTermsAccepted') === 'true';
    if (persistedAccepted) {
      checkbox.checked = true;
    }

    // Initialize button state
    checkoutBtn.disabled = !checkbox.checked;
    updateMiniCartButtonStyle(checkoutBtn, checkbox.checked);

    // (Re)bind listener for this checkbox
    checkboxHandler = function() {
      sessionStorage.setItem('miniCartTermsAccepted', String(this.checked));
      checkoutBtn.disabled = !this.checked;
      updateMiniCartButtonStyle(checkoutBtn, this.checked);
    };
    checkbox.addEventListener('change', checkboxHandler);

    boundCheckbox = checkbox;
  }

  // Improved mini-cart detection
  function initMiniCartWhenVisible() {
    const miniCart = document.getElementById('mini-cart');
    if (miniCart && miniCart.getAttribute('aria-hidden') === 'false') {
      // Use requestAnimationFrame to ensure DOM is fully rendered
      requestAnimationFrame(() => {
        setTimeout(setupMiniCartCheckout, 50);
      });
    }
  }

  // Run setup when mini-cart opens
  document.addEventListener('click', function(event) {
    if (event.target.closest('.header__cart-toggle')) {
      // Multiple attempts to ensure it works
      setTimeout(initMiniCartWhenVisible, 50);
      setTimeout(initMiniCartWhenVisible, 150);
      setTimeout(initMiniCartWhenVisible, 300);
    }
  });

  // Initialize on page load
  document.addEventListener('DOMContentLoaded', function() {
    setTimeout(setupMiniCartCheckout, 100);
  });
  
  // Re-initialize after cart updates (listen to theme event fired by cart rerenders)
  document.addEventListener('theme:loading:end', function() {
    // Delay slightly to allow DOM replacement to finish
    setTimeout(setupMiniCartCheckout, 50);
  });
  
  // Additional event listener for drawer mutations
  const observer = new MutationObserver(function(mutations) {
    mutations.forEach(function(mutation) {
      if (mutation.type === 'attributes' && mutation.attributeName === 'aria-hidden') {
        const target = mutation.target;
        if (target.getAttribute('aria-hidden') === 'false') {
          setTimeout(setupMiniCartCheckout, 50);
        }
      }
    });
  });

  // Start observing the mini-cart for changes
  const miniCart = document.getElementById('mini-cart');
  if (miniCart) {
    observer.observe(miniCart, { attributes: true });
  }

  // Backup method - check periodically when mini-cart is visible
  setInterval(function() {
    const miniCart = document.getElementById('mini-cart');
    const checkbox = document.getElementById('miniCartTermsCheckbox');
    const checkoutBtn = document.getElementById('miniCartCheckoutButton');
    
    if (miniCart && miniCart.getAttribute('aria-hidden') === 'false' && checkbox && checkoutBtn) {
      // If the currently bound checkbox is not the live one, re-bind
      if (checkbox !== boundCheckbox) {
        setupMiniCartCheckout();
      }
    }
  }, 500);

  // Cart Note Functionality
  function setupCartNoteHandlers() {
    const toggle = document.getElementById('miniCartNoteToggle');
    const noteBox = document.getElementById('miniCartNoteBox');
    const noteText = document.getElementById('miniCartNoteText');
    const saveBtn = document.getElementById('miniCartNoteSave');
    const noteLabel = document.getElementById('miniCartNoteLabel');
    const chevron = document.getElementById('miniCartNoteChevron');
    
    if (!toggle || !noteBox || !noteText || !saveBtn || !noteLabel || !chevron) return;
    
    // Track if dropdown is currently open
    let isOpen = false;
    
    // Remove existing listeners to prevent duplicates
    const newToggle = toggle.cloneNode(true);
    toggle.parentNode.replaceChild(newToggle, toggle);
    const newSaveBtn = saveBtn.cloneNode(true);
    saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);
    
    // Get references again after cloning
    const finalToggle = document.getElementById('miniCartNoteToggle');
    const finalChevron = document.getElementById('miniCartNoteChevron');
    
    // Toggle dropdown on click
    finalToggle.addEventListener('click', function() {
      isOpen = !isOpen;
      
      if (isOpen) {
        noteBox.style.display = 'block';
        if (finalChevron) {
          finalChevron.style.transform = 'rotate(180deg)';
        }
      } else {
        noteBox.style.display = 'none';
        if (finalChevron) {
          finalChevron.style.transform = 'rotate(0deg)';
        }
      }
    });
    
    // Save note to cart
    newSaveBtn.addEventListener('click', function() {
      const note = noteText.value.trim();
      const originalText = this.textContent;
      
      // Show saving state
      this.textContent = 'Saving...';
      this.disabled = true;
      
      // Update cart note via AJAX
      fetch('/cart/update.js', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          note: note
        })
      })
      .then(response => response.json())
      .then(data => {
        // Show success feedback
        this.textContent = 'Saved!';
        
        // Minimize the dropdown after saving
        setTimeout(() => {
          const box = document.getElementById('miniCartNoteBox');
          const chevronEl = document.getElementById('miniCartNoteChevron');
          if (box) {
            box.style.display = 'none';
            isOpen = false;
          }
          if (chevronEl) {
            chevronEl.style.transform = 'rotate(0deg)';
          }
          this.textContent = 'Save Note';
          this.disabled = false;
        }, 1000);
      })
      .catch(error => {
        console.error('Error saving cart note:', error);
        this.textContent = 'Error - Try Again';
        setTimeout(() => {
          this.textContent = originalText;
          this.disabled = false;
        }, 2000);
      });
    });
  }
  
  // Initialize cart note handlers on page load
  document.addEventListener('DOMContentLoaded', function() {
    setTimeout(setupCartNoteHandlers, 100);
  });
  
  // Re-initialize after cart updates
  document.addEventListener('theme:loading:end', function() {
    setTimeout(setupCartNoteHandlers, 50);
  });
  
  // Initialize when mini-cart opens
  document.addEventListener('click', function(event) {
    if (event.target.closest('.header__cart-toggle')) {
      setTimeout(setupCartNoteHandlers, 50);
      setTimeout(setupCartNoteHandlers, 150);
      setTimeout(setupCartNoteHandlers, 300);
    }
  });
  
  // Re-initialize when mini-cart becomes visible
  const miniCartObserver = new MutationObserver(function(mutations) {
    mutations.forEach(function(mutation) {
      if (mutation.type === 'attributes' && mutation.attributeName === 'aria-hidden') {
        const target = mutation.target;
        if (target.getAttribute('aria-hidden') === 'false') {
          setTimeout(setupCartNoteHandlers, 50);
        }
      }
    });
  });
  
  const miniCartForNoteObserver = document.getElementById('mini-cart');
  if (miniCartForNoteObserver) {
    miniCartObserver.observe(miniCartForNoteObserver, { attributes: true });
  }
</script>
  
